import os
import json
import re

def find_github_commit_references(text):
    github_commit_references = []

    # Regex for GitHub commit URLs
    commit_regex = re.compile(r'https://github\.com/[^/]+/[^/]+/commit/[a-fA-F\d]+')

    # Find all GitHub commit URLs in the text
    github_commit_references = re.findall(commit_regex, text)
    
    return github_commit_references

def search_in_cve_files(root_folder, vcs_platform):
    for root, dirs, files in os.walk(root_folder):
        for file in files:
            if file.endswith('.json') and file.startswith('CVE-'):
                file_path = os.path.join(root, file)
                print(f"Processing file: {file_path}")
                with open(file_path, 'r') as json_file:
                    try:
                        cve_data = json.load(json_file)
                        references = cve_data.get('containers', {}).get('cna', {}).get('references', [])
                        
                        for reference in references:
                            if 'url' in reference:
                                url = reference['url']
                                github_commit_references = find_github_commit_references(url)
                                if github_commit_references and vcs_platform.lower() in url.lower():
                                    print(f"Found in {file_path}: {url}")
                    except json.JSONDecodeError:
                        print(f"Error decoding JSON in {file_path}")

# Example usage
base_folder = '/Users/faisal/Documents/bachelor-prosjekt'
cve_folder = os.path.join(base_folder, 'cves')
vcs_platform_to_search = 'github'

search_in_cve_files(cve_folder, vcs_platform_to_search)

